<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teste de Notifica√ß√µes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        textarea {
            height: 80px;
            resize: vertical;
        }
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .logs {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .permission-status {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .permission-granted {
            background-color: #d4edda;
            color: #155724;
        }
        .permission-denied {
            background-color: #f8d7da;
            color: #721c24;
        }
        .permission-default {
            background-color: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîî Teste de Notifica√ß√µes</h1>
        
        <div id="permission-status" class="permission-status"></div>
        
        <div class="form-group">
            <label for="title">T√≠tulo da Notifica√ß√£o:</label>
            <input type="text" id="title" value="PowerZap" placeholder="Digite o t√≠tulo..." />
        </div>
        
        <div class="form-group">
            <label for="text">Texto da Notifica√ß√£o:</label>
            <textarea id="text" placeholder="Digite o texto da notifica√ß√£o...">Nova mensagem recebida!</textarea>
        </div>
        
        <div class="buttons">
            <button class="btn-primary" onclick="testNotification()">üîî Testar Notifica√ß√£o</button>
            <button class="btn-secondary" onclick="requestPermission()">üîë Solicitar Permiss√£o</button>
            <button class="btn-secondary" onclick="clearLogs()">üóëÔ∏è Limpar Logs</button>
        </div>
        
        <div id="status"></div>
        
        <div id="logs" class="logs"></div>
    </div>

<script>
    function needsServiceWorker() {
        const userAgent = navigator.userAgent.toLowerCase();
        const isChrome = userAgent.includes('chrome') && !userAgent.includes('edg');
        const isSecureContext = window.location.protocol === 'https:' || 
                               window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
        return isChrome && isSecureContext;
    }

    async function notifyPop(title, text) {
        try {
            logMessage("üîç Iniciando teste de notifica√ß√£o...");
            if (!('Notification' in window)) {
                logMessage("‚ùå Notification API n√£o suportada neste navegador");
                showStatus("Notification API n√£o suportada neste navegador", "error");
                return false;
            }

            if (Notification.permission !== "granted") {
                logMessage("‚ö†Ô∏è Permiss√£o n√£o concedida: " + Notification.permission);
                showStatus("Permiss√£o n√£o concedida. Clique em 'Solicitar Permiss√£o' primeiro.", "warning");
                return false;
            }

            logMessage("üìù T√≠tulo: " + title);
            logMessage("üìù Texto: " + text);
            logMessage("üì® Tentando enviar notifica√ß√£o...");
            await new Promise(resolve => setTimeout(resolve, 2000));

            try {
                if (!needsServiceWorker()) {
                    const notification = new Notification(title, {
                        body: text,
                        tag: 'powerzap',
                        icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjMDA3QkZGIi8+Cjwvc3ZnPgo=',
                        vibrate: [200, 100, 200],
                        silent: false
                    });
                    notification.onclick = function () {
                        logMessage("üëÜ Notifica√ß√£o clicada!");
                        window.focus();
                        notification.close();
                    };
                    notification.onshow = function() {
                        logMessage("‚úÖ Notifica√ß√£o exibida com sucesso!");
                        showStatus("Notifica√ß√£o enviada com sucesso!", "success");
                    };
                    notification.onerror = function(error) {
                        logMessage("‚ùå Erro ao exibir notifica√ß√£o: " + error);
                        showStatus("Erro ao exibir notifica√ß√£o", "error");
                    };
                    logMessage("‚úÖ Notifica√ß√£o criada com construtor direto!");
                    return true;
                }
            } catch (error) {
                logMessage("‚ö†Ô∏è Construtor direto falhou: " + error.message);
                logMessage("üîÑ Tentando m√©todo alternativo...");
            }

            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.ready;
                    if (registration && registration.showNotification) {
                        await registration.showNotification(title, {
                            body: text,
                            tag: 'powerzap',
                            icon: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjMDA3QkZGIi8+Cjwvc3ZnPgo=',
                            vibrate: [200, 100, 200],
                            requireInteraction: false
                        });
                        logMessage("‚úÖ Notifica√ß√£o enviada via Service Worker existente!");
                        showStatus("Notifica√ß√£o enviada com sucesso via Service Worker!", "success");
                        return true;
                    }
                } catch (error) {
                    logMessage("‚ö†Ô∏è Service Worker existente falhou: " + error.message);
                }
            }

            try {
                logMessage("üîÑ Tentando for√ßar construtor direto...");
                const notification = new Notification(title, {
                    body: text,
                    tag: 'powerzap'
                });
                notification.onclick = function () {
                    logMessage("üëÜ Notifica√ß√£o clicada!");
                    window.focus();
                    notification.close();
                };
                logMessage("‚úÖ Notifica√ß√£o for√ßada com sucesso!");
                showStatus("Notifica√ß√£o enviada (m√©todo alternativo)!", "success");
                return true;
            } catch (error) {
                logMessage("‚ùå Todos os m√©todos falharam: " + error.message);
                showStatus("Erro: Navegador n√£o permite notifica√ß√µes neste contexto. Tente usar HTTPS ou localhost.", "error");
                return false;
            }
        } catch (error) {
            logMessage("‚ùå Erro geral: " + error.message);
            showStatus("Erro geral: " + error.message, "error");
            return false;
        }
    }

    async function testNotification() {
        const title = document.getElementById('title').value || 'PowerZap';
        const text = document.getElementById('text').value || 'Nova mensagem recebida!';
        logMessage("üöÄ Iniciando teste...");
        logMessage("üîç Contexto: " + (needsServiceWorker() ? "Requer Service Worker" : "Construtor direto OK"));
        await notifyPop(title, text);
    }

    async function requestPermission() {
        if (!('Notification' in window)) {
            showStatus("Notification API n√£o suportada", "error");
            return;
        }
        try {
            const permission = await Notification.requestPermission();
            logMessage("üìã Permiss√£o solicitada: " + permission);
            updatePermissionStatus();
            if (permission === "granted") {
                showStatus("Permiss√£o concedida! Agora voc√™ pode testar as notifica√ß√µes.", "success");
            } else {
                showStatus("Permiss√£o negada. Verifique as configura√ß√µes do navegador.", "error");
            }
        } catch (error) {
            logMessage("‚ùå Erro ao solicitar permiss√£o: " + error.message);
            showStatus("Erro ao solicitar permiss√£o", "error");
        }
    }

    function updatePermissionStatus() {
        const statusElement = document.getElementById('permission-status');
        if (!('Notification' in window)) {
            statusElement.textContent = "‚ùå Notification API n√£o suportada";
            statusElement.className = "permission-status permission-denied";
            return;
        }
        const permission = Notification.permission;
        switch (permission) {
            case 'granted':
                statusElement.textContent = "‚úÖ Permiss√£o concedida - Notifica√ß√µes habilitadas";
                statusElement.className = "permission-status permission-granted";
                break;
            case 'denied':
                statusElement.textContent = "‚ùå Permiss√£o negada - Notifica√ß√µes bloqueadas";
                statusElement.className = "permission-status permission-denied";
                break;
            default:
                statusElement.textContent = "‚ö†Ô∏è Permiss√£o pendente - Clique em 'Solicitar Permiss√£o'";
                statusElement.className = "permission-status permission-default";
        }
    }

    function showStatus(message, type) {
        const statusElement = document.getElementById('status');
        statusElement.textContent = message;
        statusElement.className = `status ${type}`;
        statusElement.style.display = 'block';
    }

    function logMessage(message) {
        const logsElement = document.getElementById('logs');
        const timestamp = new Date().toLocaleTimeString();
        logsElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        logsElement.scrollTop = logsElement.scrollHeight;
    }

    function clearLogs() {
        document.getElementById('logs').innerHTML = '';
        document.getElementById('status').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
        updatePermissionStatus();
        logMessage("üéØ P√°gina carregada - Pronto para testes!");
        logMessage("üîç Navegador: " + navigator.userAgent.split(' ').pop());
        logMessage("üîí Protocolo: " + window.location.protocol);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(() => logMessage('‚úÖ Service Worker registrado com sucesso!'))
                .catch(e => logMessage('‚ùå Erro ao registrar Service Worker: ' + e.message));
        }
    });
</script>
</body>
</html>
